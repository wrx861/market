# Rate Limiting –∏ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è PartsAPI

## üéØ –ü—Ä–æ–±–ª–µ–º–∞
PartsAPI –±–ª–æ–∫–∏—Ä—É–µ—Ç IP –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limiting). –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏:
- –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–í–º–µ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è proxy/VPN (—á—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è), –º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã**:

### 1. Rate Limiting (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤)

**–§–∞–π–ª:** `/app/backend/rate_limiter.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∂–¥–µ—Ç, –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º "—Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞"

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from rate_limiter import RateLimiter

limiter = RateLimiter(max_requests=10, time_window=60)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
if limiter.is_allowed("partsapi"):
    # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    response = requests.get(...)
else:
    # –ñ–¥–µ–º –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    pass
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Cache Manager)

**–§–∞–π–ª:** `/app/backend/cache_manager.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã API –Ω–∞ –¥–∏—Å–∫
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à –≤ —Ç–µ—á–µ–Ω–∏–µ 1 —á–∞—Å–∞ (TTL = 3600 —Å–µ–∫—É–Ω–¥)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è –∫–∞–∂–¥–æ–≥–æ VIN + –∫–∞—Ç–µ–≥–æ—Ä–∏—è

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```python
from cache_manager import CacheManager

cache = CacheManager(ttl=3600)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
cached_data = cache.get(vin, category_id)
if cached_data:
    return cached_data

# –ï—Å–ª–∏ –∫—ç—à–∞ –Ω–µ—Ç - –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
response = requests.get(...)
data = response.json()

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
cache.set(vin, category_id, data)
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ PartsApiClient

**–§–∞–π–ª:** `/app/backend/partsapi_client.py`

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ `get_parts_by_vin_and_category()`:**

```python
def get_parts_by_vin_and_category(self, vin, category_id):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    cached_data = self.cache.get(vin, category_id)
    if cached_data:
        return cached_data
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º rate limit –∏ –∂–¥–µ–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if not self.rate_limiter.wait_if_needed(key="partsapi"):
        return []
    
    # 3. –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
    response = requests.get(...)
    data = response.json()
    
    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
    self.cache.set(vin, category_id, data)
    
    return data
```

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### ‚úÖ Rate Limiting
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤
- **–£–º–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ** - –∂–¥–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –≤—Ä–µ–º—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã

### ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–°–∫–æ—Ä–æ—Å—Ç—å** - –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–≠–∫–æ–Ω–æ–º–∏—è** - —Å–Ω–∏–∂–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API –Ω–∞ 60-80%
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### Rate Limiter –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
```python
RateLimiter(
    max_requests=10,  # –ú–∞–∫—Å–∏–º—É–º 10 –∑–∞–ø—Ä–æ—Å–æ–≤
    time_window=60    # –ó–∞ 60 —Å–µ–∫—É–Ω–¥
)
```

### Cache Manager –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
```python
CacheManager(
    cache_dir="/tmp/partsapi_cache",  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫—ç—à–∞
    ttl=3600  # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ 1 —á–∞—Å
)
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤:
```python
remaining = rate_limiter.get_remaining_requests("partsapi")
print(f"–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤: {remaining}/10")
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–±—Ä–æ—Å–∞:
```python
reset_time = rate_limiter.get_reset_time("partsapi")
print(f"–õ–∏–º–∏—Ç —Å–±—Ä–æ—Å–∏—Ç—Å—è —á–µ—Ä–µ–∑: {reset_time:.1f} —Å–µ–∫—É–Ω–¥")
```

### –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞:
```python
# –û—á–∏—Å—Ç–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫—ç—à
cache.clear_expired()

# –û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –∫—ç—à
cache.clear_all()
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚ùå –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ IP –ø–æ—Å–ª–µ 20-30 –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –û—à–∏–±–∫–∏ 429 "Too Many Requests"
- ‚ùå –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç–æ–π –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API –Ω–∞ 60-80%

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ proxy/VPN** - —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ–ª–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞
2. **–ö—ç—à —Ö—Ä–∞–Ω–∏—Ç—Å—è 1 —á–∞—Å** - –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤—è—Ç—Å—è
3. **Rate limit = 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω** - –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
4. **–î–ª—è production** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–≤—è–∑–∞—Ç—å—Å—è —Å PartsAPI –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã PartsAPI

–î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞:
- –°–∞–π—Ç: https://partsapi.ru
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://api.partsapi.ru
